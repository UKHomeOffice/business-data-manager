{% extends "layout.html" %}

{% block page_title %}
  {{ app_title }} - {{ title }}
{% endblock %}

{% block inside_header %}
  {% include "partials/header.html" %}
{% endblock %}

{% block main_content %}
    <div class="grid-row">
      <div class="column-full">
        <h1 class="heading-xlarge">{{ title }}</h1>
      </div>
    </div>


    <div class="grid-row">
      <div class="column-full">
        <h2 class="heading-large">{{ data.name }}</h2>
        <p>The dataset's Id is set to: {{ data.idType }}</p>
        <p>The dataset currently has the following additional properties:</p>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Datatype</th>
              <th>Not null</th>
              <th>Unique</th>
              <th>Foreign key</th>
              <th>Validators</th>
            </tr>
          </thead>
          <tbody>
            {% for field in data.fields %}
              <tr>
                <td>{{ field.name }}</td>
                <td>{{ field.datatype }}</td>
                <td>{{ field.notNull }}</td>
                <td>{{ field.unique }}</td>
                <td>{{ field.foreignKey }}</td>
                <td>
                  {% for name, options in field.validators %}
                    <span>{{ name }}
                      {% if options | length %}:
                        {% for p, v in options %}
                          {{ p }}={{ v }}
                        {% endfor %}
                      {% endif %}
                    </span>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
          <tbody>
        </table>
      </div>
    </div>

    {% if Authenticator.authorise('dataset', 'write') %}
        <div class="grid-row">
          <div class="column-full">
            <h2 class="heading-large">Add a field</h2>
            <p>You can add fields to the {{ data.name }} dataset by completing the form below.</p>

            <form method="POST" action="/v1/datasets/{{ data.name }}/properties">
              <input type='hidden' name="_csrf" value="{{ _csrf }}">
              <input type="hidden" name="versioned" value="{{ data.versioned }}">
              <input type="hidden" name="idType" value="{{ data.idType }}">
              <h3 class="heading-medium">Field name</h3>
              <div class="form-group">
                <input class="form-control" id="name" name="name" type="text">
              </div>
              <div class="form-group">
                <fieldset class="inline">
                  <legend>
                    <h3 class="heading-medium">Field data type</h3>
                  </legend>
                  <div class="multiple-choice">
                    <input id="datatype-1" type="radio" name="datatype" value="VARCHAR">
                    <label for="datatype-1">Text</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="datatype-2" type="radio" name="datatype" value="DATE">
                    <label for="datatype-2">Date</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="datatype-3" type="radio" name="datatype" value="INTEGER">
                    <label for="datatype-3">Integer</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="datatype-4" type="radio" name="datatype" value="NUMERIC">
                    <label for="datatype-4">Numeric</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="datatype-5" type="radio" name="datatype" value="TIMESTAMP">
                    <label for="datatype-5">Timestamp</label>
                  </div>
                </fieldset>
              </div>
              <!-- <div class="form-group">
                <fieldset class="inline">
                  <legend>
                    <h3 class="heading-medium">Primary key</h3>
                  </legend>
                  <div class="multiple-choice">
                    <input id="primaryKey-1" type="radio" name="primaryKey" value="Yes">
                    <label for="primaryKey-1">Yes</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="primaryKey-2" type="radio" name="primaryKey" value="No">
                    <label for="primaryKey-2">No</label>
                  </div>
                </fieldset>
              </div> -->
              <div class="form-group">
                <fieldset class="inline">
                  <legend>
                    <h3 class="heading-medium">Not null</h3>
                  </legend>
                  <div class="multiple-choice">
                    <input id="notNull-1" type="radio" name="notNull" value="Yes">
                    <label for="notNull-1">Yes</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="notNull-2" type="radio" name="notNull" value="No">
                    <label for="notNull-2">No</label>
                  </div>
                </fieldset>
              </div>
              <div class="form-group">
                <fieldset class="inline">
                  <legend>
                    <h3 class="heading-medium">Unique</h3>
                  </legend>
                  <div class="multiple-choice">
                    <input id="unique-1" type="radio" name="unique" value="Yes">
                    <label for="unique-1">Yes</label>
                  </div>
                  <div class="multiple-choice">
                    <input id="unique-2" type="radio" name="unique" value="No">
                    <label for="unique-2">No</label>
                  </div>
                </fieldset>
              </div>
              <div class="form-group">
                <fieldset class="inline">
                  <legend>
                    <h3 class="heading-medium">Foreign key</h3>
                  </legend>
                  <label for="foreignKey">Related dataset:</label>
                  <select class="form-control" name="foreignKey" id="foreignKey">
                    <option></option>
                    {% for fkDataset in foreignKeyDatasets %}
                      <option value="{{ fkDataset.name }}">{{ fkDataset.name }} ({{ fkDataset.idType }})</option>
                    {% endfor %}
                  </select>
                </fieldset>
              </div>

              <div class="form-group">
                <input class="button" type="submit" value="Add field">
              </div>
            </form>
          </div>
        </div>
    {% endif %}

    {% if Authenticator.authorise('dataset', 'delete') and not data.versioned and data.idType in ['SERIAL', 'INTEGER'] %}
    <div class="error-summary" role="alert">
      <h2 class="heading-large">Danger zone</h2>
      <span class="error-message">
        You can add versioning this dataset. It cannot be reversed.
      </span>
      <br>
      <span class="error-message">
        Only do this if you are absolutely sure!
      </span>
      <br>
      <form method="POST" action="/v1/datasets/{{data.name}}/version">
        <input type='hidden' name="_csrf" value="{{ _csrf }}">
        <input type="hidden" name="name" value="{{data.name}}">
        <input type="hidden" name="fields" value="{{data.fields | dump}}">
        <input type="hidden" name="org" value="{{data.org}}">
        <input type="hidden" name="idType" value="{{data.idType}}">
        <input type="hidden" name="versioned" value="true">
        <div class="form-group">
           <input class="button" type="submit" value="Version dataset">
        </div>
      </form>
    </div>
    {% endif %}

    {% if Authenticator.authorise('dataset', 'delete') %}
    <div class="error-summary" role="alert">
      <h2 class="heading-large">Danger zone</h2>
      <span class="error-message">
        You can delete the dataset here.
      </span>
      <br>
      <span class="error-message">
        Only do this if you are absolutely sure!
      </span>
      <br>
      <form method="POST" action="/v1/datasets/{{data.name}}/delete">
        <input type='hidden' name="_csrf" value="{{ _csrf }}">
        <div class="form-group">
           <a href="#" onclick="document.forms[1].submit();return false;" name="delete-button">Delete</a>
        </div>
      </form>
    </div>
    {% endif %}

    <!-- {% include "partials/pagination.html" %} -->
{% endblock %}
