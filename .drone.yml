---
kind: pipeline
name: default
type: kubernetes

platform:
  os: linux
  arch: amd64

workspace:
  path: /go/src/gitlab.digital.homeoffice.gov.uk/${DRONE_REPO}

steps:
- name: build_monitor_image
  pull: if-not-exists
  image: plugins/docker
  settings:
    dockerfile: Dockerfile
    force_tag: true
    registry: quay.io
    repo: quay.io/ukhomeofficedigital/business-data-manager
    tags:
    - latest
    - ${DRONE_COMMIT_SHA}
    - b${DRONE_BUILD_NUMBER}
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  when:
    branch:
    - master
    - hotfix/*
    - feature/*
    event:
    - push

- name: trivy_scan
 pull: if-not-exists
 image: quay.io/ukhomeofficedigital/trivyscanner:master
 commands:
 - trivy image --ignore-unfixed --exit-code 0 --no-progress quay.io/ukhomeofficedigital/business-data-manager:${DRONE_COMMIT_SHA}
 when:
   branch:
   - hotfix/*
   - feature/*
   event:
   - push

- name: deploy_to_dev
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/kd
  commands:
  - export NODE_ENV=$${NODE_ENV}
  - export LOG_LEVEL=$${LOG_LEVEL}
  - export HOSTNAME=$${NOTPROD_HOSTNAME}
  - export KEYCLOAK_CLIENT_ID=$${NOTPROD_KEYCLOAK_CLIENT_ID}
  - export KEYCLOAK_CLIENT_SECRET=$${NOTPROD_KEYCLOAK_CLIENT_SECRET}
  - export KEYCLOAK_DISCOVERY=$${NOTPROD_KEYCLOAK_DISCOVERY}
  - export KEYCLOAK_ID=$${NOTPROD_KEYCLOAK_ID}
  - export KEYCLOAK_SECRET=$${NOTPROD_KEYCLOAK_SECRET}
  - export KEYCLOAK_DISCOVERY_URL=$${NOTPROD_KEYCLOAK_DISCOVERY_URL}
  - export KUBE_SERVER=$$NOTPROD_KUBE_SERVER
  - export KUBE_TOKEN=$$NOTPROD_KUBE_TOKEN
  - export RDS_SECRET_NAME=dq-apps-notprod-postgres-rds
  - export DB_ATTRIBUTE=database_name
  - kd -f kube/secret.yml -f kube/deployment.yml -f kube/service.yml -f kube/ingress.yml -f kube/network-policy.yml
  environment:
    ENV: notprod
    KUBE_NAMESPACE: dq-apps-notprod
    INSECURE_SKIP_TLS_VERIFY: true
    NOTPROD_HOSTNAME:
      from_secret: NOTPROD_HOSTNAME
    NODE_ENV:
      from_secret: NODE_ENV
    LOG_LEVEL:
      from_secret: LOG_LEVEL
    NOTPROD_KEYCLOAK_CLIENT_ID:
      from_secret: NOTPROD_KEYCLOAK_CLIENT_ID
    NOTPROD_KEYCLOAK_CLIENT_SECRET:
      from_secret: NOTPROD_KEYCLOAK_CLIENT_SECRET
    NOTPROD_KEYCLOAK_DISCOVERY:
      from_secret: NOTPROD_KEYCLOAK_DISCOVERY
    NOTPROD_KUBE_SERVER:
      from_secret: NOTPROD_KUBE_SERVER
    NOTPROD_KUBE_TOKEN:
      from_secret: NOTPROD_KUBE_TOKEN
    NOTPROD_KEYCLOAK_ID:
      from_secret: NOTPROD_KEYCLOAK_ID
    NOTPROD_KEYCLOAK_SECRET:
      from_secret: NOTPROD_KEYCLOAK_SECRET
    NOTPROD_KEYCLOAK_DISCOVERY_URL:
      from_secret: NOTPROD_KEYCLOAK_DISCOVERY_URL
  when:
    branch:
    - master
    - hotfix/*
    - feature/*
    event:
    - promote
    - push
    target:
      exclude:
      - production

- name: deploy_to_staging
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/kd
  commands:
  - export NODE_ENV=$${NODE_ENV}
  - export LOG_LEVEL=$${LOG_LEVEL}
  - export HOSTNAME=$${STAGING_HOSTNAME}
  - export KEYCLOAK_CLIENT_ID=$${NOTPROD_KEYCLOAK_CLIENT_ID}
  - export KEYCLOAK_CLIENT_SECRET=$${NOTPROD_KEYCLOAK_CLIENT_SECRET}
  - export KEYCLOAK_DISCOVERY=$${NOTPROD_KEYCLOAK_DISCOVERY}
  - export KEYCLOAK_ID=$${NOTPROD_KEYCLOAK_ID}
  - export KEYCLOAK_SECRET=$${NOTPROD_KEYCLOAK_SECRET}
  - export KEYCLOAK_DISCOVERY_URL=$${NOTPROD_KEYCLOAK_DISCOVERY_URL}
  - export KUBE_SERVER=$$PROD_KUBE_SERVER
  - export KUBE_TOKEN=$$STAGING_KUBE_TOKEN
  - export RDS_SECRET_NAME=dq-apps-bdm-staging-rds
  - export DB_ATTRIBUTE=db_name
  - export PGHOST=$${STAGING_PGHOST}
  - export PGPORT=$${STAGING_PGPORT}
  - export PGUSER=$${STAGING_PGUSER}
  - export PGDATABASE=$${STAGING_PGDATABASE}
  - export PGPASSWORD=$${STAGING_PGPASSWORD}
  - export SESSION_SECRET=$${STAGING_SESSION_SECRET}
  - kd -f kube/secret.yml -f kube/dq-staging-rds-secret.yml -f kube/service.yml -f kube/ingress.yml -f kube/network-policy.yml -f kube/deployment.yml
  environment:
    ENV: prod
    KUBE_NAMESPACE: dq-apps-staging
    INSECURE_SKIP_TLS_VERIFY: true
    NODE_ENV:
      from_secret: NODE_ENV
    LOG_LEVEL:
      from_secret: LOG_LEVEL
    STAGING_HOSTNAME:
      from_secret: STAGING_HOSTNAME
    NOTPROD_KEYCLOAK_CLIENT_ID:
      from_secret: NOTPROD_KEYCLOAK_CLIENT_ID
    NOTPROD_KEYCLOAK_CLIENT_SECRET:
      from_secret: NOTPROD_KEYCLOAK_CLIENT_SECRET
    NOTPROD_KEYCLOAK_DISCOVERY:
      from_secret: NOTPROD_KEYCLOAK_DISCOVERY
    PROD_KUBE_SERVER:
      from_secret: PROD_KUBE_SERVER
    STAGING_KUBE_TOKEN:
      from_secret: STAGING_KUBE_TOKEN
    NOTPROD_KEYCLOAK_ID:
      from_secret: NOTPROD_KEYCLOAK_ID
    NOTPRODKEYCLOAK_SECRET:
      from_secret: NOTPROD_KEYCLOAK_SECRET
    NOTPROD_KEYCLOAK_DISCOVERY_URL:
      from_secret: NOTPROD_KEYCLOAK_DISCOVERY_URL
    STAGING_PGHOST:
      from_secret: STAGING_PGHOST
    STAGING_PGPORT:
      from_secret: STAGING_PGPORT
    STAGING_PGUSER:
      from_secret: STAGING_PGUSER
    STAGING_PGDATABASE:
      from_secret: STAGING_PGDATABASE
    STAGING_PGPASSWORD:
      from_secret: STAGING_PGPASSWORD
    STAGING_SESSION_SECRET:
      from_secret: STAGING_SESSION_SECRET
  when:
    branch:
    - master
    - hotfix/*
    event:
    - promote
    target:
    - staging

- name: deploy_to_prod
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/kd
  commands:
  - export NODE_ENV=$${NODE_ENV}
  - export LOG_LEVEL=$${LOG_LEVEL}
  - export HOSTNAME=$${PROD_HOSTNAME}
  - export KEYCLOAK_CLIENT_ID=$${PROD_KEYCLOAK_CLIENT_ID}
  - export KEYCLOAK_CLIENT_SECRET=$${PROD_KEYCLOAK_CLIENT_SECRET}
  - export KEYCLOAK_DISCOVERY=$${PROD_KEYCLOAK_DISCOVERY}
  - export KEYCLOAK_ID=$${PROD_KEYCLOAK_ID}
  - export KEYCLOAK_SECRET=$${PROD_KEYCLOAK_SECRET}
  - export KEYCLOAK_DISCOVERY_URL=$${PROD_KEYCLOAK_DISCOVERY_URL}
  - export KUBE_SERVER=$$PROD_KUBE_SERVER
  - export KUBE_TOKEN=$$PROD_KUBE_TOKEN
  - export RDS_SECRET_NAME=dq-apps-bdm-prod-rds
  - export DB_ATTRIBUTE=db_name
  - kd -f kube/secret.yml -f kube/deployment.yml -f kube/service.yml -f kube/ingress.yml -f kube/network-policy.yml
  environment:
    ENV: prod
    KUBE_NAMESPACE: dq-apps
    INSECURE_SKIP_TLS_VERIFY: true
    NODE_ENV:
      from_secret: NODE_ENV
    LOG_LEVEL:
      from_secret: LOG_LEVEL
    PROD_HOSTNAME:
      from_secret: PROD_HOSTNAME
    PROD_KEYCLOAK_CLIENT_ID:
      from_secret: PROD_KEYCLOAK_CLIENT_ID
    PROD_KEYCLOAK_CLIENT_SECRET:
      from_secret: PROD_KEYCLOAK_CLIENT_SECRET
    PROD_KEYCLOAK_DISCOVERY:
      from_secret: PROD_KEYCLOAK_DISCOVERY
    PROD_KUBE_SERVER:
      from_secret: PROD_KUBE_SERVER
    PROD_KUBE_TOKEN:
      from_secret: PROD_KUBE_TOKEN
    PROD_KEYCLOAK_ID:
      from_secret: PROD_KEYCLOAK_ID
    PROD_KEYCLOAK_SECRET:
      from_secret: PROD_KEYCLOAK_SECRET
    PROD_KEYCLOAK_DISCOVERY_URL:
      from_secret: PROD_KEYCLOAK_DISCOVERY_URL
  when:
    branch:
    - master
    - hotfix/*
    event:
    - promote
    target:
    - production

services:
- name: docker
  image: 340268328991.dkr.ecr.eu-west-2.amazonaws.com/acp/dind

...
